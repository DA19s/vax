
> vax@1.0.0 test:integration
> jest --config=jest.integration.config.js children.vaccinations.test.js

  console.log
    [dotenv@17.2.3] injecting env (2) from .env.test -- tip: ÔÜÖ´©Å  enable debug logging with { debug: true }

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.log
    Ô£à Configuration de test charg├®e depuis .env.test

      at Object.<anonymous> (tests/integration/jest.env.js:26:9)

  console.log
    [dotenv@17.2.3] injecting env (18) from .env -- tip: ÔÜÖ´©Å  enable debug logging with { debug: true }

      at _log (node_modules/dotenv/lib/main.js:142:11)

  console.error
    Error: Error: Acc├¿s refus├®
        at ensureRegional (C:\Users\daibr\vax\src\controllers\districtController.js:6:19)
        at ensureRegional (C:\Users\daibr\vax\src\controllers\districtController.js:306:5)
        at Layer.handleRequest (C:\Users\daibr\vax\node_modules\router\lib\layer.js:152:17)
        at next (C:\Users\daibr\vax\node_modules\router\lib\route.js:157:13)
        at next (C:\Users\daibr\vax\src\middleware\auth.js:24:5)
        at processTicksAndRejections (node:internal/process/task_queues:105:5) {
      status: 403
    }

    [0m [90m 1 |[39m [36mconst[39m errorHandler [33m=[39m (error[33m,[39m _req[33m,[39m res[33m,[39m _next) [33m=>[39m {
    [31m[1m>[22m[39m[90m 2 |[39m   console[33m.[39merror([32m"Error:"[39m[33m,[39m error)[33m;[39m
     [90m   |[39m           [31m[1m^[22m[39m
     [90m 3 |[39m   console[33m.[39merror([32m"Stack:"[39m[33m,[39m error[33m.[39mstack)[33m;[39m
     [90m 4 |[39m   
     [90m 5 |[39m   [36mlet[39m status [33m=[39m error[33m.[39mstatus [33m||[39m [35m500[39m[33m;[39m[0m

      at error (src/middleware/errorHandler.js:2:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at next (node_modules/router/lib/route.js:132:14)
      at next (src/controllers/districtController.js:334:5)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at next (src/middleware/auth.js:24:5)

  console.error
    Stack: Error: Acc├¿s refus├®
        at ensureRegional (C:\Users\daibr\vax\src\controllers\districtController.js:6:19)
        at ensureRegional (C:\Users\daibr\vax\src\controllers\districtController.js:306:5)
        at Layer.handleRequest (C:\Users\daibr\vax\node_modules\router\lib\layer.js:152:17)
        at next (C:\Users\daibr\vax\node_modules\router\lib\route.js:157:13)
        at next (C:\Users\daibr\vax\src\middleware\auth.js:24:5)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)

    [0m [90m 1 |[39m [36mconst[39m errorHandler [33m=[39m (error[33m,[39m _req[33m,[39m res[33m,[39m _next) [33m=>[39m {
     [90m 2 |[39m   console[33m.[39merror([32m"Error:"[39m[33m,[39m error)[33m;[39m
    [31m[1m>[22m[39m[90m 3 |[39m   console[33m.[39merror([32m"Stack:"[39m[33m,[39m error[33m.[39mstack)[33m;[39m
     [90m   |[39m           [31m[1m^[22m[39m
     [90m 4 |[39m   
     [90m 5 |[39m   [36mlet[39m status [33m=[39m error[33m.[39mstatus [33m||[39m [35m500[39m[33m;[39m
     [90m 6 |[39m   [36mlet[39m message [33m=[39m error[33m.[39mmessage [33m||[39m [32m"Une erreur est survenue"[39m[33m;[39m[0m

      at error (src/middleware/errorHandler.js:3:11)
      at Layer.handleError (node_modules/router/lib/layer.js:116:17)
      at trimPrefix (node_modules/router/index.js:340:13)
      at node_modules/router/index.js:297:9
      at processParams (node_modules/router/index.js:582:12)
      at next (node_modules/router/index.js:291:5)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at node_modules/router/index.js:688:15
      at next (node_modules/router/index.js:276:14)
      at next (node_modules/router/lib/route.js:132:14)
      at next (src/controllers/districtController.js:334:5)
      at Layer.handleRequest (node_modules/router/lib/layer.js:152:17)
      at next (node_modules/router/lib/route.js:157:13)
      at next (src/middleware/auth.js:24:5)

node.exe : FAIL tests/integration/children.vaccinations.test.js (15.553 s)
Au caractère Ligne:1 : 1
+ & "C:\Program Files\nodejs/node.exe" "C:\Program Files\nodejs/node_mo ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (FAIL tests/inte...t.js (15.553 s) 
   :String) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
 
  Children API - Vaccinations
    GET /api/children/:id/vaccinations - Liste des vaccinations
      Authentification
        ÔêÜ Retourne 401 si non authentifi├® (610 ms)
      Autorisation
        ├ù Retourne 403 si utilisateur n'a pas acc├¿s g├®ographique (496 ms)
      Validation
        ÔêÜ Retourne 404 si enfant non trouv├® (612 ms)
      Succ├¿s
        ÔêÜ Retourne la liste des vaccinations avec toutes les cat├®gories 
(496 ms)
    POST /api/children/:id/vaccinations/:bucket - Cr├®ation entr├®e manuelle
      Authentification
        ÔêÜ Retourne 401 si non authentifi├® (471 ms)
      Validation
        ÔêÜ Retourne 400 si bucket invalide (389 ms)
        ÔêÜ Retourne 404 si enfant non trouv├® (382 ms)
        ÔêÜ Retourne 403 si AGENT_STAFF essaie de cr├®er (403 ms)
      Bucket: due
        ÔêÜ Cr├®e une entr├®e due avec succ├¿s (AGENT ADMIN) (410 ms)
        ÔêÜ Cr├®e une entr├®e due avec succ├¿s (NATIONAL) (386 ms)
        ÔêÜ Cr├®e une entr├®e due avec succ├¿s (REGIONAL) (392 ms)
        ÔêÜ Cr├®e une entr├®e due avec succ├¿s (DISTRICT) (381 ms)
      Bucket: late
        ÔêÜ Cr├®e une entr├®e late avec succ├¿s (397 ms)
      Bucket: overdue
        ÔêÜ Cr├®e une entr├®e overdue avec succ├¿s (416 ms)
      Bucket: completed
        ÔêÜ Cr├®e une entr├®e completed avec succ├¿s (392 ms)
        ÔêÜ Cr├®e une entr├®e completed avec administeredById sp├®cifi├® (384 
ms)
    PUT /api/children/:id/vaccinations/:bucket/:entryId - Modification entr├®e
      Authentification
        ÔêÜ Retourne 401 si non authentifi├® (433 ms)
      Validation
        ÔêÜ Retourne 400 si bucket invalide (426 ms)
        ÔêÜ Retourne 404 si entr├®e non trouv├®e (416 ms)
        ÔêÜ Retourne 400 si aucune donn├®e ├á mettre ├á jour (416 ms)
        ÔêÜ Retourne 403 si AGENT_STAFF essaie de modifier (419 ms)
      Succ├¿s
        ÔêÜ Modifie une entr├®e due avec succ├¿s (410 ms)
        ÔêÜ Modifie une entr├®e late avec succ├¿s (427 ms)
        ÔêÜ Modifie une entr├®e completed avec succ├¿s (435 ms)
    DELETE /api/children/:id/vaccinations/:bucket/:entryId - Suppression 
entr├®e
      Authentification
        ÔêÜ Retourne 401 si non authentifi├® (447 ms)
      Validation
        ÔêÜ Retourne 400 si bucket invalide (419 ms)
        ÔêÜ Retourne 404 si entr├®e non trouv├®e (420 ms)
        ÔêÜ Retourne 403 si AGENT_STAFF essaie de supprimer (518 ms)
      Succ├¿s
        ÔêÜ Supprime une entr├®e due avec succ├¿s (434 ms)
        ÔêÜ Supprime une entr├®e late avec succ├¿s (415 ms)
        ÔêÜ Supprime une entr├®e completed avec succ├¿s (410 ms)

  ÔùÅ Children API - Vaccinations ÔÇ║ GET /api/children/:id/vaccinations - 
Liste des vaccinations ÔÇ║ Autorisation ÔÇ║ Retourne 403 si utilisateur n'a 
pas acc├¿s g├®ographique

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 403

    [0m [90m 521 |[39m           
[33m.[39m[36mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer 
${nationalToken}`[39m)
     [90m 522 |[39m           [33m.[39msend({ name[33m:[39m 
[32m`OtherDistrict-${Date.now()}`[39m[33m,[39m communeId[33m:[39m 
otherCommuneId })[33m;[39m
    [31m[1m>[22m[39m[90m 523 |[39m         expect(otherDistrictRes[33m.
[39mstatusCode)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m     |[39m                                             
[31m[1m^[22m[39m
     [90m 524 |[39m         [36mconst[39m otherDistrictId [33m=[39m 
otherDistrictRes[33m.[39mbody[33m.[39mid[33m;[39m
     [90m 525 |[39m
     [90m 526 |[39m         [36mconst[39m otherHealthCenterRes [33m=[39m 
[36mawait[39m request(app)[0m

      at Object.toBe (tests/integration/children.vaccinations.test.js:523:45)

Test Suites: 1 failed, 1 total
Tests:       1 failed, 30 passed, 31 total
Snapshots:   0 total
Time:        15.614 s
Ran all test suites matching children.vaccinations.test.js.
Jest did not exit one second after the test run has completed.

'This usually means that there are asynchronous operations that weren't 
stopped in your tests. Consider running Jest with `--detectOpenHandles` to 
troubleshoot this issue.
